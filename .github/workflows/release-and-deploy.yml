name: Release and Deploy

# æ­¤ workflow åŒ…å«å®Œæ•´çš„ CI/CD æµç¨‹
# CI: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶å¹¶åˆ›å»º GitHub Release
# CD: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆé»˜è®¤ç¦ç”¨ï¼Œæ¨èä½¿ç”¨ Webhook æ–¹å¼ï¼‰
#
# æ¨èéƒ¨ç½²æ–¹å¼ï¼š
# 1. GitHub Release åˆ›å»ºåï¼Œä¼šè‡ªåŠ¨è§¦å‘é…ç½®å¥½çš„ Webhook
# 2. æœåŠ¡å™¨ä¸Šçš„ webhook-server.py æ¥æ”¶é€šçŸ¥å¹¶è‡ªåŠ¨éƒ¨ç½²
# 3. æ— éœ€åœ¨æ­¤ workflow ä¸­é…ç½®éƒ¨ç½²é€»è¾‘
#
# å‚è€ƒæ–‡æ¡£ï¼š
# - WEBHOOK_SETUP.md: Webhook é…ç½®æŒ‡å—
# - AUTO_DEPLOY_GUIDE.md: éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          GIT_COMMIT=$(git rev-parse --short HEAD)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "git_commit=$GIT_COMMIT" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Version: $VERSION"
          echo "â° Build Time: $BUILD_TIME"
          echo "ğŸ”– Git Commit: $GIT_COMMIT"

      - name: Build binaries
        env:
          VERSION: ${{ steps.version.outputs.version }}
          BUILD_TIME: ${{ steps.version.outputs.build_time }}
          GIT_COMMIT: ${{ steps.version.outputs.git_commit }}
        run: |
          echo "ğŸ”¨ Building binaries..."

          # Build for Linux AMD64
          GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT}" \
            -o simple-go-app-linux-amd64 .

          # Make binary executable
          chmod +x simple-go-app-linux-amd64

          # Show file info
          ls -lh simple-go-app-*

          echo "âœ… Build completed"

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## ğŸš€ Release ${{ steps.version.outputs.version }}

            ### ğŸ“¦ Built Artifacts
            - `simple-go-app-linux-amd64` - Linux AMD64

            ### ğŸ“ Build Info
            - **Version:** ${{ steps.version.outputs.version }}
            - **Build Time:** ${{ steps.version.outputs.build_time }}
            - **Git Commit:** ${{ steps.version.outputs.git_commit }}

            ### ğŸ“¥ Installation
            ```bash
            # Download binary
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/simple-go-app-linux-amd64

            # Make executable
            chmod +x simple-go-app-linux-amd64

            # Run
            ./simple-go-app-linux-amd64
            ```

            ### ğŸš€ Auto Deploy
            This release will be automatically deployed to configured servers via webhook.
          draft: false
          prerelease: false
          files: simple-go-app-linux-amd64

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # è‡ªåŠ¨éƒ¨ç½²é…ç½®è¯´æ˜
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  #
  # æœ¬é¡¹ç›®ä½¿ç”¨ GitHub Webhook å®ç°è‡ªåŠ¨éƒ¨ç½²ï¼Œæ— éœ€åœ¨ workflow ä¸­é…ç½®éƒ¨ç½²é€»è¾‘ã€‚
  #
  # é…ç½®æ­¥éª¤ï¼š
  #
  # 1. åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… webhook-serverï¼š
  #    curl -sSL https://raw.githubusercontent.com/flywheel-research/simple-go-app/main/install-webhook-server.sh | sudo bash
  #
  # 2. åœ¨ GitHub é…ç½® Webhookï¼š
  #    Repository â†’ Settings â†’ Webhooks â†’ Add webhook
  #    - Payload URL: http://your-server:9666/webhook
  #    - Content type: application/json
  #    - Secret: (webhook secret)
  #    - Events: âœ“ Releases only
  #
  # 3. å·¥ä½œæµç¨‹ï¼š
  #    - æ¨é€ tag â†’ GitHub Actions æ„å»º â†’ åˆ›å»º Release
  #    - GitHub è§¦å‘ Webhook â†’ æœåŠ¡å™¨æ¥æ”¶é€šçŸ¥
  #    - webhook-server.py è°ƒç”¨ deploy.sh
  #    - ä» GitHub Release ä¸‹è½½äºŒè¿›åˆ¶å¹¶éƒ¨ç½²
  #
  # å‚è€ƒæ–‡æ¡£ï¼š
  # - WEBHOOK_SETUP.md - Webhook å®Œæ•´é…ç½®æŒ‡å—
  # - QUICK_START.md - å¿«é€Ÿå¼€å§‹æŒ‡å—
  # - README.md - å®Œæ•´é¡¹ç›®æ–‡æ¡£
