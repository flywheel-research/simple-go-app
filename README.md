# Simple Go App - CI/CD å®Œæ•´ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ CI/CD ç¤ºä¾‹é¡¹ç›®ï¼Œå±•ç¤ºå¦‚ä½•ä»ä»£ç æäº¤åˆ°è‡ªåŠ¨éƒ¨ç½²çš„å…¨æµç¨‹ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [CI/CD æµç¨‹](#cicd-æµç¨‹)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
- [ç°åº¦å‘å¸ƒ](#ç°åº¦å‘å¸ƒ)
- [å›æ»šæœºåˆ¶](#å›æ»šæœºåˆ¶)
- [ç›‘æ§å‘Šè­¦](#ç›‘æ§å‘Šè­¦)

---

## é¡¹ç›®ç®€ä»‹

### åŠŸèƒ½ç‰¹æ€§

- âœ… ç®€å•çš„ HTTP æœåŠ¡å™¨
- âœ… å¥åº·æ£€æŸ¥æ¥å£ `/health`
- âœ… ç‰ˆæœ¬ä¿¡æ¯æ¥å£ `/version`
- âœ… è‡ªåŠ¨æ„å»ºï¼ˆGitHub Actionsï¼‰
- âœ… è‡ªåŠ¨å‘å¸ƒï¼ˆGitHub Releaseï¼‰
- âœ… è‡ªåŠ¨éƒ¨ç½²ï¼ˆCD è„šæœ¬ï¼‰
- âœ… ç°åº¦å‘å¸ƒæ”¯æŒ
- âœ… ä¸€é”®å›æ»š

### æŠ€æœ¯æ ˆ

- **è¯­è¨€ï¼š** Go 1.21
- **CIï¼š** GitHub Actions
- **CDï¼š** Shell Scripts
- **æœåŠ¡ç®¡ç†ï¼š** Supervisor
- **ç›‘æ§ï¼š** ï¼ˆå¾…é›†æˆï¼‰

---

## å¿«é€Ÿå¼€å§‹

### æœ¬åœ°è¿è¡Œ

```bash
# 1. å…‹éš†ä»£ç 
git clone https://github.com/flywheel-research/simple-go-app.git
cd simple-go-app

# 2. è¿è¡Œ
go run main.go

# 3. æµ‹è¯•
curl http://localhost:8080/
curl http://localhost:8080/health
curl http://localhost:8080/version
```

### æœ¬åœ°æ„å»º

```bash
# æ„å»º Linux AMD64
GOOS=linux GOARCH=amd64 go build -o simple-go-app-linux-amd64 .

# è¿è¡Œ
./simple-go-app-linux-amd64
```

---

## CI/CD æµç¨‹

### æ•´ä½“æ¶æ„

```
å¼€å‘è€…æäº¤ä»£ç 
    â†“
æ¨é€ Tag (v1.0.0)
    â†“
GitHub Actions è§¦å‘
    â†“
CIï¼šç¼–è¯‘å¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
    â†“
åˆ›å»º GitHub Release
    â†“
ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶åˆ° Release
    â†“
CDï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°ç¯å¢ƒ
    â†“
å¥åº·æ£€æŸ¥å’ŒéªŒè¯
```

### CI æµç¨‹ï¼ˆGitHub Actionsï¼‰

**è§¦å‘æ¡ä»¶ï¼š**
- æ¨é€ Tagï¼ˆå¦‚ `v1.0.0`ï¼‰
- æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰

**æ„å»ºæ­¥éª¤ï¼š**
1. Checkout ä»£ç 
2. è®¾ç½® Go ç¯å¢ƒ
3. è·å–ç‰ˆæœ¬ä¿¡æ¯
4. ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆLinux AMD64/ARM64ï¼‰
5. åˆ›å»º GitHub Release
6. ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶

**é…ç½®æ–‡ä»¶ï¼š** `.github/workflows/release.yml`

### CD æµç¨‹ï¼ˆè‡ªåŠ¨éƒ¨ç½²ï¼‰

**éƒ¨ç½²é˜¶æ®µï¼š**
1. **Dev ç¯å¢ƒï¼š** Tag åŒ…å« `-dev` åç¼€ï¼ˆå¦‚ `v1.0.0-dev`ï¼‰
2. **Staging ç¯å¢ƒï¼š** Tag åŒ…å« `-beta` åç¼€ï¼ˆå¦‚ `v1.0.0-beta`ï¼‰
3. **Production ç¯å¢ƒï¼š** æ­£å¼ç‰ˆæœ¬ Tagï¼ˆå¦‚ `v1.0.0`ï¼‰

**éƒ¨ç½²è„šæœ¬ï¼š** `deploy/deploy.sh`

---

## éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- Linux æœåŠ¡å™¨ï¼ˆUbuntu 20.04+ / CentOS 7+ï¼‰
- Supervisor å·²å®‰è£…
- ecs-user è´¦æˆ·å·²é…ç½®
- curl, jq å·²å®‰è£…

### æ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. å¤åˆ¶éƒ¨ç½²è„šæœ¬åˆ°æœåŠ¡å™¨
scp -r deploy/ ecs-user@server:/tmp/

# 2. ç™»å½•æœåŠ¡å™¨
ssh ecs-user@server

# 3. æ‰§è¡Œéƒ¨ç½²
cd /tmp/deploy
chmod +x *.sh
sudo ./deploy.sh v1.0.0 prod
```

### æ‰¹é‡éƒ¨ç½²ï¼ˆJumpServerï¼‰

```bash
# ä½¿ç”¨ JumpServer æ‰¹é‡å‘½ä»¤
curl -sSL https://raw.githubusercontent.com/flywheel-research/simple-go-app/main/deploy/deploy.sh | sudo bash -s v1.0.0 prod
```

### éƒ¨ç½²éªŒè¯

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo supervisorctl status simple-go-app

# 2. æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:8080/health

# 3. æ£€æŸ¥ç‰ˆæœ¬
curl http://localhost:8080/version

# 4. æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/simple-go-app.log
```

---

## ç°åº¦å‘å¸ƒ

### ç°åº¦å‘å¸ƒç­–ç•¥

**ä¸‰é˜¶æ®µå‘å¸ƒï¼š**

```
é˜¶æ®µ 1ï¼š10% ç°åº¦ï¼ˆCanaryï¼‰
    â†“
ç›‘æ§ 15-30 åˆ†é’Ÿ
    â†“
é˜¶æ®µ 2ï¼š50% ç°åº¦
    â†“
ç›‘æ§ 30-60 åˆ†é’Ÿ
    â†“
é˜¶æ®µ 3ï¼š100% å…¨é‡
```

### æ‰§è¡Œç°åº¦å‘å¸ƒ

```bash
# é˜¶æ®µ 1ï¼š10% ç°åº¦ï¼ˆCanary æœåŠ¡å™¨ï¼‰
./canary-deploy.sh v1.0.0 1

# ç›‘æ§ 15-30 åˆ†é’Ÿï¼Œç¡®è®¤æ— é—®é¢˜åç»§ç»­

# é˜¶æ®µ 2ï¼š50% ç°åº¦
./canary-deploy.sh v1.0.0 2

# ç›‘æ§ 30-60 åˆ†é’Ÿï¼Œç¡®è®¤æ— é—®é¢˜åç»§ç»­

# é˜¶æ®µ 3ï¼š100% å…¨é‡
./canary-deploy.sh v1.0.0 3
```

### ç›‘æ§æŒ‡æ ‡

åœ¨æ¯ä¸ªé˜¶æ®µéœ€è¦ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

**æœåŠ¡æŒ‡æ ‡ï¼š**
- âœ… æœåŠ¡çŠ¶æ€ï¼ˆRUNNINGï¼‰
- âœ… å¥åº·æ£€æŸ¥é€šè¿‡ç‡
- âœ… å“åº”æ—¶é—´ï¼ˆP50/P95/P99ï¼‰
- âœ… é”™è¯¯ç‡

**ç³»ç»ŸæŒ‡æ ‡ï¼š**
- âœ… CPU ä½¿ç”¨ç‡
- âœ… å†…å­˜ä½¿ç”¨ç‡
- âœ… ç£ç›˜ I/O
- âœ… ç½‘ç»œæµé‡

**ä¸šåŠ¡æŒ‡æ ‡ï¼ˆæ ¹æ®å®é™…æƒ…å†µï¼‰ï¼š**
- âœ… è®¢å•é‡
- âœ… äº¤æ˜“æˆåŠŸç‡
- âœ… ç”¨æˆ·æ´»è·ƒåº¦

---

## å›æ»šæœºåˆ¶

### ç‰ˆæœ¬ç®¡ç†

ç³»ç»Ÿè‡ªåŠ¨ä¿ç•™æœ€è¿‘ 5 ä¸ªç‰ˆæœ¬ï¼š

```
/opt/simple-go-app/
â”œâ”€â”€ simple-go-app              # å½“å‰è¿è¡Œç‰ˆæœ¬
â”œâ”€â”€ .current_version          # å½“å‰ç‰ˆæœ¬å·
â”œâ”€â”€ .previous_version         # ä¸Šä¸€ä¸ªç‰ˆæœ¬å·
â”œâ”€â”€ backup/                   # å¤‡ä»½ç›®å½•
â”‚   â”œâ”€â”€ simple-go-app-v1.0.0-20231024_120000
â”‚   â”œâ”€â”€ simple-go-app-v0.9.0-20231023_150000
â”‚   â””â”€â”€ ...
â””â”€â”€ versions/                 # æ‰€æœ‰ä¸‹è½½çš„ç‰ˆæœ¬
    â”œâ”€â”€ simple-go-app-v1.0.0
    â”œâ”€â”€ simple-go-app-v0.9.0
    â””â”€â”€ ...
```

### å¿«é€Ÿå›æ»š

```bash
# 1. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
./rollback.sh

# 2. å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
./rollback.sh v0.9.0

# 3. éªŒè¯å›æ»š
curl http://localhost:8080/version
```

### å›æ»šæµç¨‹

```
æ£€æµ‹åˆ°é—®é¢˜
    â†“
æ‰§è¡Œå›æ»šè„šæœ¬
    â†“
åœæ­¢å½“å‰æœåŠ¡
    â†“
æ¢å¤æ—§ç‰ˆæœ¬äºŒè¿›åˆ¶
    â†“
å¯åŠ¨æœåŠ¡
    â†“
å¥åº·æ£€æŸ¥
    â†“
ç‰ˆæœ¬éªŒè¯
```

---

## å‘å¸ƒæµç¨‹å®æˆ˜

### å®Œæ•´å‘å¸ƒæµç¨‹

#### æ­¥éª¤ 1ï¼šå¼€å‘å’Œæµ‹è¯•

```bash
# 1. å¼€å‘æ–°åŠŸèƒ½
git checkout -b feature/new-feature
# ... å¼€å‘ä»£ç  ...

# 2. æœ¬åœ°æµ‹è¯•
go test ./...
go run main.go

# 3. æäº¤ä»£ç 
git add .
git commit -m "Add new feature"
git push origin feature/new-feature

# 4. åˆ›å»º Pull Requestï¼Œåˆå¹¶åˆ° main
```

#### æ­¥éª¤ 2ï¼šåˆ›å»º Dev ç‰ˆæœ¬

```bash
# 1. æ‰“ Dev Tag
git tag v1.1.0-dev
git push origin v1.1.0-dev

# 2. GitHub Actions è‡ªåŠ¨æ„å»º
#    - ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶
#    - åˆ›å»º GitHub Release
#    - è‡ªåŠ¨éƒ¨ç½²åˆ° Dev ç¯å¢ƒ

# 3. éªŒè¯ Dev ç¯å¢ƒ
curl http://dev-server:8080/version
```

#### æ­¥éª¤ 3ï¼šåˆ›å»º Beta ç‰ˆæœ¬

```bash
# 1. Dev æµ‹è¯•é€šè¿‡åï¼Œæ‰“ Beta Tag
git tag v1.1.0-beta
git push origin v1.1.0-beta

# 2. è‡ªåŠ¨éƒ¨ç½²åˆ° Staging ç¯å¢ƒ

# 3. éªŒè¯ Staging ç¯å¢ƒ
curl http://staging-server:8080/version
```

#### æ­¥éª¤ 4ï¼šç°åº¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ

```bash
# 1. Beta æµ‹è¯•é€šè¿‡åï¼Œæ‰“æ­£å¼ Tag
git tag v1.1.0
git push origin v1.1.0

# 2. é˜¶æ®µ 1ï¼š10% ç°åº¦
./canary-deploy.sh v1.1.0 1
# ç›‘æ§ 15-30 åˆ†é’Ÿ

# 3. é˜¶æ®µ 2ï¼š50% ç°åº¦
./canary-deploy.sh v1.1.0 2
# ç›‘æ§ 30-60 åˆ†é’Ÿ

# 4. é˜¶æ®µ 3ï¼š100% å…¨é‡
./canary-deploy.sh v1.1.0 3
# æŒç»­ç›‘æ§ 24-48 å°æ—¶
```

#### æ­¥éª¤ 5ï¼šç›‘æ§å’Œå‘Šè­¦

```bash
# ç›‘æ§å…³é”®æŒ‡æ ‡
# - æœåŠ¡å¥åº·çŠ¶æ€
# - é”™è¯¯ç‡
# - å“åº”æ—¶é—´
# - ä¸šåŠ¡æŒ‡æ ‡

# å¦‚å‘ç°é—®é¢˜ï¼Œç«‹å³å›æ»š
./rollback.sh
```

---

## ç›‘æ§å‘Šè­¦

### æœåŠ¡ç›‘æ§

**Supervisor çŠ¶æ€ç›‘æ§ï¼š**
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
sudo supervisorctl status

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡
sudo supervisorctl status simple-go-app
```

**å¥åº·æ£€æŸ¥ï¼š**
```bash
# å®šæœŸå¥åº·æ£€æŸ¥ï¼ˆå¯é…ç½® cronï¼‰
*/1 * * * * curl -s http://localhost:8080/health || echo "Health check failed"
```

### æ—¥å¿—ç›‘æ§

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/simple-go-app.log

# é”™è¯¯æ—¥å¿—è¿‡æ»¤
sudo tail -f /var/log/simple-go-app.log | grep -i error

# æ—¥å¿—åˆ†æ
sudo cat /var/log/simple-go-app.log | grep "ERROR" | wc -l
```

### å‘Šè­¦é…ç½®

**å»ºè®®å‘Šè­¦è§„åˆ™ï¼š**
- âŒ æœåŠ¡åœæ­¢è¿è¡Œ
- âŒ å¥åº·æ£€æŸ¥å¤±è´¥è¶…è¿‡ 3 æ¬¡
- âŒ é”™è¯¯ç‡è¶…è¿‡ 1%
- âŒ å“åº”æ—¶é—´ P95 è¶…è¿‡ 1 ç§’
- âŒ CPU ä½¿ç”¨ç‡è¶…è¿‡ 80%
- âŒ å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 85%

---

## æœ€ä½³å®è·µ

### ç‰ˆæœ¬å‘½åè§„èŒƒ

```
v<major>.<minor>.<patch>[-<pre-release>]

ç¤ºä¾‹:
v1.0.0          # æ­£å¼ç‰ˆæœ¬ï¼ˆProductionï¼‰
v1.0.0-dev      # å¼€å‘ç‰ˆæœ¬ï¼ˆDevï¼‰
v1.0.0-beta     # æµ‹è¯•ç‰ˆæœ¬ï¼ˆStagingï¼‰
v1.0.0-rc1      # å€™é€‰ç‰ˆæœ¬
```

### å‘å¸ƒæ£€æŸ¥æ¸…å•

**å‘å¸ƒå‰ï¼š**
- [ ] ä»£ç å·²åˆå¹¶åˆ° main åˆ†æ”¯
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] Release Notes å·²å‡†å¤‡

**å‘å¸ƒä¸­ï¼š**
- [ ] CI æ„å»ºæˆåŠŸ
- [ ] äºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸Šä¼ 
- [ ] Dev ç¯å¢ƒéƒ¨ç½²æˆåŠŸ
- [ ] Beta ç¯å¢ƒæµ‹è¯•é€šè¿‡

**å‘å¸ƒåï¼š**
- [ ] ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- [ ] å›æ»šæ–¹æ¡ˆå°±ç»ª
- [ ] å›¢é˜Ÿé€šçŸ¥å·²å‘é€

### å›æ»šå†³ç­–

**ç«‹å³å›æ»šçš„æƒ…å†µï¼š**
- âŒ æœåŠ¡æ— æ³•å¯åŠ¨
- âŒ å¥åº·æ£€æŸ¥æŒç»­å¤±è´¥
- âŒ é”™è¯¯ç‡æ€¥å‰§ä¸Šå‡ï¼ˆ>5%ï¼‰
- âŒ æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ä¸å¯ç”¨

**æš‚åœå‘å¸ƒå¹¶è§‚å¯Ÿï¼š**
- âš ï¸ é”™è¯¯ç‡ç•¥æœ‰ä¸Šå‡ï¼ˆ1-5%ï¼‰
- âš ï¸ å“åº”æ—¶é—´ç•¥æœ‰å¢åŠ 
- âš ï¸ éƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. éƒ¨ç½²å¤±è´¥**
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
curl -I https://github.com

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥æƒé™
ls -la /opt/simple-go-app/
```

**2. æœåŠ¡æ— æ³•å¯åŠ¨**
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo tail -100 /var/log/simple-go-app.log

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 8080

# æ‰‹åŠ¨è¿è¡Œæµ‹è¯•
cd /opt/simple-go-app
./simple-go-app
```

**3. ç‰ˆæœ¬éªŒè¯å¤±è´¥**
```bash
# æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶
/opt/simple-go-app/simple-go-app --version

# æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶
cat /opt/simple-go-app/.current_version

# å¯¹æ¯”å®é™…è¿è¡Œç‰ˆæœ¬
curl http://localhost:8080/version
```

---

## ç›®å½•ç»“æ„

```
simple-go-app/
â”œâ”€â”€ main.go                      # ä¸»ç¨‹åº
â”œâ”€â”€ go.mod                       # Go æ¨¡å—å®šä¹‰
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ release.yml          # GitHub Actions CI é…ç½®
â””â”€â”€ deploy/
    â”œâ”€â”€ deploy.sh                # éƒ¨ç½²è„šæœ¬
    â”œâ”€â”€ rollback.sh              # å›æ»šè„šæœ¬
    â””â”€â”€ canary-deploy.sh         # ç°åº¦å‘å¸ƒè„šæœ¬
```

---

## å‚è€ƒèµ„æ–™

- [Go å®˜æ–¹æ–‡æ¡£](https://go.dev/doc/)
- [GitHub Actions æ–‡æ¡£](https://docs.github.com/en/actions)
- [Supervisor æ–‡æ¡£](http://supervisord.org/)
- [12-Factor App](https://12factor.net/)

---

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

## License

MIT License
